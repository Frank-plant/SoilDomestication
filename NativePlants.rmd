---
title: "Native Plants"
output: html_notebook
---

```{r}
library(vegan)
library(broom)
library(tidyverse)
```

```{r}
## Do Not Run
#wExp <- readRDS("~/RMB/SoilDomestication/Data/wExp.rds")
#wExp %>% 
#  filter(Site == "Arkansas") %>% 
#  ungroup() %>% 
#  saveRDS("~/RMB/SoilDomestication/Data/native_plants_data.rds")

nExp <- readRDS("~/RMB/SoilDomestication/Data/native_plants_data.rds")
tax <- readRDS("~/RMB/SoilDomestication/Data/gg_otus_tax.rds")
```

```{r}
long_pcoa <- function(x){
  require(vegan)
  x2 <- x %>% 
    dplyr::select(SampleID, variable, RA, Compartment, host_common_name) %>% 
    spread(variable, RA, fill = 0)
  pc <- capscale(log2(x2[,4:ncol(x2)] + 1) ~ 1)
  pc.axes <- bind_cols(x2[,1:3], as_tibble(scores(pc, choices = c(1:5))$sites))
  pc.eig <- eigenvals(pc) / sum(eigenvals(pc))
  pc.results <- list(axes = pc.axes, eig = pc.eig)
  return(pc.results)
}
```

```{r}
nPC <- long_pcoa(nExp %>% group_by(variable) %>% filter(sum(value) > 0) %>% mutate(RA = RA*1000))
nPC$axes %>% 
  ggplot(aes(MDS1, MDS2, color = host_common_name)) +
  geom_point(size = 3, alpha = 0.7) +
  stat_ellipse(aes(group = Compartment), color = "black") +
  scale_color_brewer(palette = "Set1", direction = -1) +
  theme_minimal() +
  labs(x = paste("PCo1 (", round(nPC$eig[1] * 100, 2), "%)", sep = ""), y = paste("PCo2 (", round(nPC$eig[2] * 100, 2), "%)", sep = ""))
```

```{r}
phyla_abund <- nExp %>% 
  inner_join(tax, by = "variable") %>% 
  group_by(SampleID, Compartment, host_common_name, Phylum2) %>% 
  summarise(phy_total = sum(RA * 1000))

phy_host_lm <- phyla_abund %>% 
  group_by(Compartment, Phylum2) %>% 
  filter(host_common_name != "Soil") %>% 
  mutate(host_common_name = fct_relevel(host_common_name, "Rice", "Redstem", "Sedge", "Mudplantain")) %>% 
  nest() %>% 
  mutate(models = map(data, ~tidy(lm(log2(phy_total + 1) ~ host_common_name, .)))) %>% 
  unnest(models) %>% 
  filter(term != "(Intercept)") %>% 
  mutate(term = gsub("host_common_name", "", term)) %>% 
  group_by(Compartment) %>% 
  mutate(p.adj = p.adjust(p.value, "fdr"))

phy_comp_lm <- phyla_abund %>% 
  group_by(Phylum2, host_common_name) %>% 
  nest() %>% 
  mutate(models = map(data, ~tidy(lm(log2(phy_total + 1) ~ Compartment, .)))) %>% 
  unnest(models) %>% 
  filter(term != "(Intercept)") %>% 
  mutate(term = gsub("Compartment", "", term)) %>% 
  mutate(p.adj = p.adjust(p.value, "bon"))

phy_comp_lm %>% 
  filter(p.adj <= 0.05) %>% 
  mutate(Phylum2 = fct_reorder(factor(Phylum2), estimate)) %>% 
  ggplot(aes(Phylum2, estimate)) +
  geom_point() +
  facet_grid(. ~ term)

phy_comp_lm %>% 
  mutate(term = fct_relevel(term, "Rhizosphere", "Endosphere")) %>% 
  ggplot(aes(term, estimate, group = Phylum2, color = ifelse(p.adj <= 0.05, term, "ns"), shape = ifelse(p.adj <= 0.05, "sig", "ns"))) +
  geom_line(color = 'black', alpha = 0.5) +
  geom_point(size = 3) +
  scale_shape_manual(values = c(1, 16)) +
  theme_minimal()
  
  

phy_host_lm %>% 
  filter(p.adj <= 0.05) %>% ungroup() %>% 
  mutate(Compartment = fct_relevel(Compartment, "Rhizosphere", "Endosphere")) %>% 
  ggplot(aes(Phylum2, term, fill = estimate)) +
  geom_tile() +
  facet_grid(Compartment~.) +
  scale_fill_gradient2(low = "gold", high = "dodgerblue") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
  

table(phyla_abund$host_common_name)
```

